
import datetime
import typing

import pytest

import sales_inference.recommendation
from sales_inference.types import Model
from sales_inference.types import SalesList
from sales_inference.types import SalesRecommendation
from sales_inference.types import SaleRecord


class RecommendationCase(typing.NamedTuple):
    ongoing: typing.List[str]
    last_recommendation: SalesRecommendation
    model: Model
    expected: SalesList


class RecommendationCaseWithAlerts(typing.NamedTuple):
    ongoing: typing.List[str]
    last_recommendation: SalesRecommendation
    model: Model
    alerts: typing.List[str]
    expected: SalesList


@pytest.fixture
def alerts_engine(request):
    yield sales_inference.recommendation.AlertsEngine('redis.example.com',
                                                      6379)


@pytest.fixture
def engine(request):
    yield sales_inference.recommendation.Engine('redis.example.com', 6379)


def _recommendation_since(seconds: int, top: typing.List[str],
                          bottom: typing.List[str]):
    offset = datetime.timedelta(seconds=seconds)
    return SalesRecommendation(
        last_time=datetime.datetime.now(datetime.timezone.utc) - offset,
        reco=SalesList(top=top, bottom=bottom),
    )


def _mk_model(sales: typing.List[SaleRecord]):
    return Model(
        sales=sales,
        updated_at=datetime.datetime.now(datetime.timezone.utc),
    )


cases = [
    RecommendationCase(
        ongoing=['A', 'B', 'C', 'D', 'E'],
        last_recommendation=_recommendation_since(
            seconds=605000,
            top=[],
            bottom=[],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='C', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='D', is_new=True, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],
        ),
        expected=SalesList(top=['D', 'E'], bottom=['C', 'A', 'B']),
    ),
    RecommendationCase(
        ongoing=['A', 'B', 'C', 'D', 'E'],
        last_recommendation=_recommendation_since(
            seconds=18000,
            top=['C', 'A'],
            bottom=['D', 'B', 'E'],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='C', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='D', is_new=True, score=9.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],
        ),
        expected=SalesList(top=['C', 'A'], bottom=['D', 'B', 'E']),
    ),
    RecommendationCase(
        ongoing=['A', 'B', 'D', 'E'],
        last_recommendation=_recommendation_since(
            seconds=3600,
            top=['C', 'A'],
            bottom=['D', 'B', 'E'],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='D', is_new=True, score=9.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ]
        ),
        expected=SalesList(top=['A', 'D'], bottom=['B', 'E']),
    ),
    RecommendationCase(
        ongoing=['A', 'B', 'D', 'E', 'F', 'G', 'H'],
        last_recommendation=_recommendation_since(
            seconds=46800,
            top=['A', 'D'],
            bottom=['B', 'E'],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='D', is_new=False, score=9.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='E', is_new=False, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='H', is_new=True, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b5', sale_id='G', is_new=True, score=6.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b6', sale_id='F', is_new=True, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],
        ),
        expected=SalesList(top=['H', 'G', 'F'], bottom=['A', 'D', 'B', 'E']),
    ),
    RecommendationCase(
        ongoing=['D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'],
        last_recommendation=_recommendation_since(
            seconds=172800,
            top=['H', 'G', 'F'],
            bottom=['A', 'D', 'B', 'E'],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='H', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='D', is_new=False, score=9.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='K', is_new=True, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='G', is_new=False, score=6.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='F', is_new=False, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b5', sale_id='J', is_new=False, score=4.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b6', sale_id='L', is_new=True, score=3.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b7', sale_id='I', is_new=False, score=3.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b8', sale_id='E', is_new=False, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],
        ),
        expected=SalesList(
            top=['K', 'L', 'J', 'I'],
            bottom=['H', 'G', 'F', 'D', 'E'],
        ),
    ),
    RecommendationCase(
        ongoing=['Z', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'],
        last_recommendation=_recommendation_since(
            seconds=14400,
            top=['K', 'J', 'L', 'I'],
            bottom=['H', 'G', 'F', 'D', 'E'],
        ),
        model=_mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='H', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='D', is_new=False, score=9.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='G', is_new=False, score=6.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='F', is_new=False, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='J', is_new=False, score=4.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b5', sale_id='I', is_new=False, score=3.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b6', sale_id='E', is_new=False, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b7', sale_id='K', is_new=True, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b8', sale_id='L', is_new=True, score=3.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b9', sale_id='Z', is_new=True, score=0.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],
        ),
        expected=SalesList(
            top=['Z', 'K', 'J', 'L', 'I'],
            bottom=['H', 'G', 'F', 'D', 'E'],
        ),
    ),
]


@pytest.mark.parametrize('ongoing,last_recommendation,model,expected', cases)
def test_mk_recommendation(engine: sales_inference.recommendation.Engine,
                           ongoing, last_recommendation, model, expected):
    recommendation = engine._mk_recommendation(
        ongoing=ongoing,
        previous=last_recommendation,
        model=model,
    )
    assert recommendation.reco == expected


trivial_alert_cases = [RecommendationCaseWithAlerts(
    ongoing=i.ongoing,
    last_recommendation=i.last_recommendation,
    model=i.model,
    alerts=[],
    expected=i.expected
    )for i in cases]


@pytest.mark.parametrize('ongoing,last_recommendation,model,alerts,expected',
                         trivial_alert_cases)
def test_trivial_alerts_recommendation(
        alerts_engine: sales_inference.recommendation.AlertsEngine,
        ongoing,
        last_recommendation,
        model,
        alerts,
        expected,):
    alerts_recommendation = alerts_engine._mk_recommendation(
        ongoing=ongoing,
        previous=last_recommendation,
        child_specific=alerts,
        model=model,
    )
    assert alerts_recommendation.reco == expected


def test_very_old_user_coming_back_with_alerts(
        alerts_engine: sales_inference.recommendation.AlertsEngine):
    last_recommendation = _recommendation_since(5*24*3600, [], [])
    model = _mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='C', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                             log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='D', is_new=True, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],)
    alerts = ['A', 'B']
    expected = SalesList(
            top=['A', 'B'],
            bottom=['D', 'E', 'B'],
            )
    ongoing = ['A', 'B', 'C', 'D', 'E']

    recommendation = alerts_engine._mk_recommendation(
        ongoing=ongoing,
        previous=last_recommendation,
        child_specific=alerts,
        model=model,
        )

    assert recommendation.reco == expected


def test_user_who_has_seen_everything_with_alerts(
        alerts_engine: sales_inference.recommendation.AlertsEngine):
    last_recommendation = _recommendation_since(1*12*3600,
                                                ['C', 'A'], ['D', 'B', 'E']
                                                )
    model = _mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='C', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='D', is_new=True, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],)
    alerts = ['A', 'B']
    expected = SalesList(
            top=['C', 'A'],
            bottom=['D', 'B', 'E'],
            )
    ongoing = ['A', 'B', 'C', 'D', 'E']

    recommendation = alerts_engine._mk_recommendation(
        ongoing=ongoing,
        previous=last_recommendation,
        child_specific=alerts,
        model=model,
        )

    assert recommendation.reco == expected


def test_user_with_seen_and_unseen_sales_and_alerts(
        alerts_engine: sales_inference.recommendation.AlertsEngine):
    last_recommendation = _recommendation_since(1*24*3600, ['C', 'A'], ['D'])
    model = _mk_model(
            sales=[
                SaleRecord(brand='b0', sale_id='C', is_new=False, score=10.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b1', sale_id='A', is_new=False, score=8.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b2', sale_id='D', is_new=True, score=5.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b3', sale_id='B', is_new=False, score=2.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
                SaleRecord(brand='b4', sale_id='E', is_new=True, score=1.0,
                           log_delta=0, log_followers=0, conversion=0, 
                           log_revenue=0, log_brand_appearance=0, log_avg_price=0,
                           artisanal=0, b_corporation=0, bio=0, biodegradable=0,
                           cadeau_ideal=0, concept_original=0, durable=0,
                           eco_friendly=0, excellent_sur_yuka=0,
                           exclusivite_choose=0, fabrication_a_la_demande=0,
                           fait_main=0, gluten_free=0, iconique=0, inclusive=0,
                           innovation=0, made_in_europe=0, made_in_france=0,
                           madeinjapan=0, naturel=0, oeko_tex=0, premium=0,
                           recyclable=0, saint_valentin=0, savoir_faire=0,
                           seconde_main=0, socialement_engagee=0, serie_limitee=0,
                           tendance=0, upcycling=0, vegan=0, vintage=0, 
                           zerodechet=0, category_sale=0),
            ],)
    alerts = ['A', 'B']
    expected = SalesList(
            top=['B', 'E'],
            bottom=['C', 'A', 'D'],
            )
    ongoing = ['A', 'B', 'C', 'D', 'E']

    recommendation = alerts_engine._mk_recommendation(
        ongoing=ongoing,
        previous=last_recommendation,
        child_specific=alerts,
        model=model,
        )

    assert recommendation.reco == expected
